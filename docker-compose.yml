---

version: '3'

networks:
  elk_node: {}
  services:
    external:
      name: 'services'

services:

  filebeat:
    build:
      context: './filebeat'
      args:
        ELK_VERSION: $ELK_VERSION
    restart: 'unless-stopped'
    user: 'root'
    logging:
      driver: 'json-file'
      options:
        max-size: "${LOGGING_MAX_SIZE}"
        max-file: "${LOGGING_MAX_FILE}"
    networks:
      - 'elk_node'
      - 'services'
    volumes:
      - '/var/log:/mnt/logs/physical-host:ro'
      - '/var/lib/docker/containers:/mnt/logs/docker:ro'
      - '/var/run/docker.sock:/var/run/docker.sock'

  metricbeat:
    build:
      context: './metricbeat'
      args:
        ELK_VERSION: $ELK_VERSION
    restart: 'unless-stopped'
    user: 'root'
    logging:
      driver: 'json-file'
      options:
        max-size: "${LOGGING_MAX_SIZE}"
        max-file: "${LOGGING_MAX_FILE}"
    networks:
      - 'elk_node'
      - 'services'
    volumes:
      - '/proc:/hostfs/proc:ro'
      - '/sys/fs/cgroup:/hostfs/sys/fs/cgroup:ro'
      - '/:/hostfs:ro'
      - '/var/run/docker.sock:/var/run/docker.sock'

  packetbeat:
    build:
      context: './packetbeat'
      args:
        ELK_VERSION: $ELK_VERSION
    restart: 'unless-stopped'
    user: 'root'
    logging:
      driver: 'json-file'
      options:
        max-size: "${LOGGING_MAX_SIZE}"
        max-file: "${LOGGING_MAX_FILE}"
    cap_add:
      - 'NET_ADMIN'
    network_mode: 'host'
    extra_hosts:
      - "elasticsearch:${ELK_CORE_ES_ADDRESS}"
      - "kibana:${ELK_CORE_KIBANA_ADDRESS}"
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'

  auditbeat:
    build:
      context: './auditbeat'
      args:
        ELK_VERSION: $ELK_VERSION
    restart: 'unless-stopped'
    user: 'root'
    logging:
      driver: 'json-file'
      options:
        max-size: "${LOGGING_MAX_SIZE}"
        max-file: "${LOGGING_MAX_FILE}"
    pid: 'host'
    privileged: true
    cap_add:
      - 'ALL'
    network_mode: 'host'
    extra_hosts:
      - "elasticsearch:${ELK_CORE_ES_ADDRESS}"
      - "kibana:${ELK_CORE_KIBANA_ADDRESS}"

  logstash:
    build:
      context: './logstash/'
      args:
        ELK_VERSION: $ELK_VERSION
    restart: 'unless-stopped'
    logging:
      driver: 'json-file'
      options:
        max-size: "${LOGGING_MAX_SIZE}"
        max-file: "${LOGGING_MAX_FILE}"
    volumes:
      - './logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml:ro'
      - './logstash/pipeline:/usr/share/logstash/pipeline:ro'
    ports:
      - "${LISTEN_IP_ADDRESS}:7000:5000"
      - "${LISTEN_IP_ADDRESS}:8000:5000"
    networks:
      - 'elk_node'
      - 'services'
    environment:
      LS_JAVA_OPTS: '-Xmx1024m -Xms1024m'
